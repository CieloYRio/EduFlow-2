<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFlow Planner - Smart Curriculum Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Geist', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI Variable', 'Segoe UI', system-ui, ui-sans-serif, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            padding: 20px;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            font-optical-sizing: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 32px 64px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 25%, #10b981 50%, #059669 75%, #047857 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="20" cy="80" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 800;
            background: linear-gradient(45deg, #ffffff, #f1f5f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            padding: 8px;
            gap: 4px;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            transform: translateY(-1px);
        }

        .content {
            padding: 30px;
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .curriculum-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subject-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .subject-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
        }

        .subject-card h3 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .subject-card p {
            color: #6b7280;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .progress-bar {
            background: #f3f4f6;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .lesson-list {
            list-style: none;
            margin-top: 16px;
        }

        .lesson-item {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-item:last-child {
            border-bottom: none;
        }

        .lesson-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-not-started {
            background: #f3f4f6;
            color: #6b7280;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
        }

        .close-modal:hover {
            color: #374151;
        }

        .planner-tab {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .planner-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .planner-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .planner-view {
            display: none;
        }

        .planner-view.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .curriculum-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📖 EduFlow Planner</h1>
            <p>Smart Curriculum Design for Modern Educators</p>
        </div>

        <!-- Participant Information Section -->
        <div id="headerSubtitle" style="padding: 20px 40px; background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%); border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
            <div id="inputSection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 16px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="learnerName" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">👨‍🎓 Learner's Name</label>
                    <input type="text" id="learnerName" class="form-control" placeholder="Enter learner's name" style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(59, 130, 246, 0.3);">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="teacherName" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">👩‍🏫 Teacher's Name</label>
                    <input type="text" id="teacherName" class="form-control" placeholder="Enter teacher's name" style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(16, 185, 129, 0.3);">
                </div>
            </div>
            <div id="headerInfo" style="display: none; justify-content: center; gap: 32px; flex-wrap: wrap; font-size: 0.95rem; color: #374151; margin-top: 16px; padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 12px; backdrop-filter: blur(10px);">
                <span id="headerLearner">👨‍🎓 Learner: <strong>Not Set</strong></span>
                <span id="headerTeacher">👩‍🏫 Teacher: <strong>Not Set</strong></span>
                <span id="headerGrade">🎓 Grade: <strong>Not Set</strong></span>
                <span id="headerYear">📅 Year: <strong>Not Set</strong></span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('overview')">📊 Overview</button>
            <button class="nav-tab" onclick="showView('subjects')">📖 Subjects</button>
            <button class="nav-tab" onclick="showView('planner')">📋 Curriculum Designer</button>
            <button class="nav-tab" onclick="showView('schedule')">🕐 Daily Schedule</button>
            <button class="nav-tab" onclick="showView('progress')">📈 Progress</button>
        </div>

        <div class="content">
            <!-- Overview View -->
            <div id="overview" class="view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSubjects">6</div>
                        <div class="stat-label">Total Subjects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedLessons">0</div>
                        <div class="stat-label">Completed Lessons</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overallProgress">0</div>
                        <div class="stat-label">Overall Progress %</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weeklyHours">0</div>
                        <div class="stat-label">Weekly Hours</div>
                    </div>
                </div>

                <h2 style="margin-bottom: 20px; color: #1f2937;">Recent Activity</h2>
                <div class="curriculum-grid">
                    <div class="subject-card">
                        <h3>🔢 Mathematics</h3>
                        <p>Ready to start: No lessons added yet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <small style="color: #6b7280;">0% Complete</small>
                    </div>
                    <div class="subject-card">
                        <h3>🔬 Science</h3>
                        <p>Ready to start: No lessons added yet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <small style="color: #6b7280;">0% Complete</small>
                    </div>
                </div>
            </div>

            <!-- Subjects View -->
            <div id="subjects" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937;">Subject Management</h2>
                    <button class="btn" onclick="openModal('addSubjectModal')">
                        ➕ Add Subject
                    </button>
                </div>

                <div class="curriculum-grid" id="subjectsGrid">
                    <!-- Subjects will be populated by JavaScript -->
                </div>
            </div>

            <!-- Planner View -->
            <div id="planner" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937; margin: 0;">Curriculum Planner</h2>
                </div>
                


                <!-- Unified Calendar & Academic Configuration -->
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #0ea5e9; margin-bottom: 20px; border-left: 6px solid #0ea5e9;">
                    <h3 style="margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                        📅 Academic Calendar Configuration
                        <span style="font-size: 0.8rem; background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 500;">Applies to Both Views</span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="globalCountryRegion">🌍 Country/Region</label>
                            <select id="globalCountryRegion" class="form-control" onchange="updateGlobalCountrySettings()">
                                <option value="us">🇺🇸 United States</option>
                                <option value="uk">🇬🇧 United Kingdom</option>
                                <option value="ca">🇨🇦 Canada</option>
                                <option value="au">🇦🇺 Australia</option>
                                <option value="nz">🇳🇿 New Zealand</option>
                                <option value="sg">🇸🇬 Singapore</option>
                                <option value="in">🇮🇳 India</option>
                                <option value="cn">🇨🇳 China</option>
                                <option value="kr">🇰🇷 South Korea</option>
                                <option value="jp">🇯🇵 Japan</option>
                                <option value="th">🇹🇭 Thailand</option>
                                <option value="my">🇲🇾 Malaysia</option>
                                <option value="ph">🇵🇭 Philippines</option>
                                <option value="id">🇮🇩 Indonesia</option>
                                <option value="ae">🇦🇪 UAE</option>
                                <option value="sa">🇸🇦 Saudi Arabia</option>
                                <option value="qa">🇶🇦 Qatar</option>
                                <option value="tr">🇹🇷 Turkey</option>
                                <option value="de">🇩🇪 Germany</option>
                                <option value="fr">🇫🇷 France</option>
                                <option value="other">🌍 Other/Add Country</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalCalendarSystem">📊 Calendar System</label>
                            <select id="globalCalendarSystem" class="form-control" onchange="updateGlobalCalendarSystem()">
                                <option value="quarterly">Quarterly (4 periods)</option>
                                <option value="semester">Semester (2 periods)</option>
                                <option value="trimester">Trimester (3 periods)</option>
                                <option value="monthly">Monthly (12 periods)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalSchoolYearStart">🗓️ School Year Start</label>
                            <input type="month" id="globalSchoolYearStart" class="form-control" onchange="updateAcademicYearFromStart(); updateGlobalCalendarSystem();">
                        </div>
                        
                        <div class="form-group">
                            <label for="globalAcademicYear">📚 Academic Year</label>
                            <select id="globalAcademicYear" class="form-control">
                                <option value="2024-2025">2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                                <option value="2026-2027">2026-2027</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalGradeLevel">🎓 Grade Level</label>
                            <select id="globalGradeLevel" class="form-control">
                                <option value="">Select Grade</option>
                                <option value="k">Kindergarten</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalInterfaceLanguage">🌐 Interface Language</label>
                            <select id="globalInterfaceLanguage" class="form-control">
                                <option value="en">English</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                                <option value="de">Deutsch</option>
                                <option value="zh">中文</option>
                                <option value="ja">日本語</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Curriculum Information Display -->
                    <div id="globalCurriculumInfo" style="padding: 16px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #0ea5e9; display: none;">
                        <h4 style="margin-bottom: 8px; color: #0c4a6e;">📋 Curriculum Standards</h4>
                        <p id="globalCurriculumStandards" style="margin: 0; color: #0369a1; font-weight: 500;"></p>
                    </div>
                </div>
                
                <!-- Planner Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 30px; background: #f8fafc; padding: 8px; border-radius: 12px;">
                    <button class="planner-tab active" onclick="showPlannerView('subject-wise')">📚 Subject-Wise Planning</button>
                    <button class="planner-tab" onclick="showPlannerView('period-wise')">📅 Period-Wise Planning</button>
                </div>

                <!-- Subject-Wise View -->
                <div id="subject-wise" class="planner-view active">
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 20px; color: #1f2937;">Subject Focus Planning</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="subjectSelect">📚 Select Subject to Plan</label>
                                <select id="subjectSelect" class="form-control" onchange="updateSubjectTitle()">
                                    <option value="">Choose a subject to focus on</option>
                                    <option value="mathematics">🔢 Mathematics</option>
                                    <option value="science">🔬 Science</option>
                                    <option value="english">📝 English</option>
                                    <option value="history">🏛️ History</option>
                                    <option value="art">🎨 Art</option>
                                    <option value="music">🎵 Music</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="subjectFocus">🎯 Planning Focus</label>
                                <select id="subjectFocus" class="form-control">
                                    <option value="unit">Single Unit/Topic</option>
                                    <option value="semester">Full Semester</option>
                                    <option value="year">Entire Academic Year</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="generateSubjectPlan()">🔄 Generate Subject-Focused Plan</button>
                    </div>

                    <!-- Monthly Planning Table -->
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                        <h3 id="monthlyPlanningTitle" style="margin-bottom: 20px; color: #1f2937;">Monthly Curriculum Planning</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #1d4ed8 100%);">
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Time Period</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Months</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Learning Objectives</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Key Concepts & Topics</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Skills & Competencies</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Assessment</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Learning Activities</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Resources & Materials</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Standard Alignments</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyPlanTable">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="addMonthlyRow()">➕ Add Period</button>
                            <button class="btn btn-secondary" onclick="addColumnToTable()">📊 Add Column</button>
                        </div>
                    </div>

                    <!-- Additional Planning Sections -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <!-- First Row - Most Important -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">🎯 Unit Learning Goals</h3>
                                <textarea id="learningGoals" class="form-control" rows="4" placeholder="Define the overarching goals and outcomes for this unit..."></textarea>
                            </div>
                            
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">📋 Prerequisites</h3>
                                <textarea id="prerequisites" class="form-control" rows="4" placeholder="List the knowledge and skills students should have before starting..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Second Row - Supporting Information -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">📝 Teaching Notes & Tips</h3>
                                <textarea id="teachingNotes" class="form-control" rows="4" placeholder="Important teaching strategies, common challenges, and helpful tips..."></textarea>
                            </div>
                            
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">🗺️ Cross-Curricular Connections</h3>
                                <textarea id="mappingInsights" class="form-control" rows="4" placeholder="Connections to other subjects and interdisciplinary opportunities..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Period-Wise View -->
                <div id="period-wise" class="planner-view">
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 20px; color: #1f2937;">Multi-Subject Period Planning</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="periodSelect" id="periodLabel">📅 Select Period to Plan</label>
                                <select id="periodSelect" class="form-control">
                                    <option value="q1">Quarter 1 (Sep-Nov)</option>
                                    <option value="q2">Quarter 2 (Dec-Feb)</option>
                                    <option value="q3">Quarter 3 (Mar-May)</option>
                                    <option value="q4">Quarter 4 (Jun-Aug)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="planningScope">🎯 Planning Scope</label>
                                <select id="planningScope" class="form-control">
                                    <option value="all">All Subjects</option>
                                    <option value="core">Core Subjects Only</option>
                                    <option value="selected">Selected Subjects</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="generatePeriodPlan()">🔄 Generate Multi-Subject Plan</button>
                    </div>

                    <!-- Weekly Planning Table -->
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 20px; color: #1f2937;">Weekly Subject Planning</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);">
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 120px;">Subject</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 150px;">Textbook</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week1Header">Week 1</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week2Header">Week 2</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week3Header">Week 3</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week4Header">Week 4</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week5Header">Week 5</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week6Header">Week 6</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week7Header">Week 7</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week8Header">Week 8</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week9Header">Week 9</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week10Header">Week 10</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week11Header">Week 11</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week12Header">Week 12</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyPlanTable">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="addSubjectRow()">➕ Add Subject</button>
                            <button class="btn btn-secondary" onclick="addWeekColumn()">📅 Add Week</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Schedule View -->
            <div id="schedule" class="view">
                <h2 style="margin-bottom: 20px; color: #1f2937;">Daily Schedule Template</h2>
                
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #1f2937;">📅 Schedule Configuration</h3>
                        <button class="btn btn-secondary" onclick="showWeeklyView()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            📅 View Full Week
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="scheduleDay">Day of Week</label>
                            <select id="scheduleDay" class="form-control" onchange="updateDaySchedule()">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDate">Date</label>
                            <input type="date" id="scheduleDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTemplate">Template Type</label>
                            <select id="scheduleTemplate" class="form-control" onchange="loadScheduleTemplate()">
                                <option value="standard">Standard Day (8 AM - 3 PM)</option>
                                <option value="extended">Extended Day (7 AM - 5 PM)</option>
                                <option value="flexible">Flexible Schedule</option>
                                <option value="custom">Custom Template</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Daily Schedule Table -->
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">🕐 Time Slot Schedule</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);">
                                    <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Time Slot</th>
                                    <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 150px;">Subject/Activity</th>
                                    <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 200px;">Learning Objectives</th>
                                    <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 200px;">Activities & Tasks</th>
                                    <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 150px;">Materials Needed</th>
                                    <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <button class="btn" onclick="addTimeSlot()" style="margin-top: 16px;">➕ Add Time Slot</button>
                </div>
            </div>

            <!-- Progress View -->
            <div id="progress" class="view">
                <h2 style="margin-bottom: 20px; color: #1f2937;">Progress Tracking</h2>
                
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px; color: #1f2937;">Subject Progress</h3>
                    <div id="progressCharts">
                        <!-- Progress charts will be populated by JavaScript -->
                    </div>
                </div>

                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                    <h3 style="margin-bottom: 16px; color: #1f2937;">Achievement Milestones</h3>
                    <div id="milestones">
                        <!-- Milestones will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-top: 30px;">
                <h3 style="margin-bottom: 16px; color: #1f2937;">📄 Export & Save Options</h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportToPDF()">
                        📄 Export PDF
                    </button>
                    <button class="btn btn-secondary" onclick="printPlanner()">
                        🖨️ Print
                    </button>
                    <button class="btn" onclick="saveTemplate()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        💾 Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div id="addSubjectModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addSubjectModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: #1f2937;">Add New Subject</h3>
            <form onsubmit="addSubject(event)">
                <div class="form-group">
                    <label for="subjectName">Subject Name</label>
                    <input type="text" id="subjectName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="subjectEmoji">Emoji</label>
                    <input type="text" id="subjectEmoji" class="form-control" placeholder="📚" maxlength="2">
                </div>
                <div class="form-group">
                    <label for="subjectDescription">Description</label>
                    <textarea id="subjectDescription" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSubjectModal')">Cancel</button>
                    <button type="submit" class="btn">Add Subject</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Weekly Schedule Modal -->
    <div id="weeklyScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <button class="close-modal" onclick="closeModal('weeklyScheduleModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: #1f2937;">📅 Weekly Schedule Overview</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);">
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 100px;">Time</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Monday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Tuesday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Wednesday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Thursday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Friday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Saturday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Sunday</th>
                        </tr>
                    </thead>
                    <tbody id="weeklyScheduleTable">
                        <!-- Weekly schedule will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="exportWeeklySchedule()">📄 Export Weekly Schedule</button>
                <button class="btn" onclick="closeModal('weeklyScheduleModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Lesson Modal -->
    <div id="addLessonModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addLessonModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: #1f2937;">Add New Lesson</h3>
            <form onsubmit="addLesson(event)">
                <div class="form-group">
                    <label for="lessonSubject">Subject</label>
                    <select id="lessonSubject" class="form-control" required>
                        <option value="">Select a subject</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lessonTitle">Lesson Title</label>
                    <input type="text" id="lessonTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lessonDate">Date</label>
                    <input type="date" id="lessonDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lessonDuration">Duration (minutes)</label>
                    <input type="number" id="lessonDuration" class="form-control" min="15" max="180" value="60">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLessonModal')">Cancel</button>
                    <button type="submit" class="btn">Add Lesson</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Auto-save functionality
        let autoSaveTimer = null;
        let lastSaveTime = null;
        let saveIndicator = null;

        // Data storage - All sections are interconnected with real progress tracking
        let subjects = [
            { id: 1, name: 'Mathematics', emoji: '🔢', description: 'Algebra, Geometry, and Statistics', progress: 0, lessons: 0, planningData: {} },
            { id: 2, name: 'Science', emoji: '🔬', description: 'Chemistry, Physics, and Biology', progress: 0, lessons: 0, planningData: {} },
            { id: 3, name: 'English', emoji: '📝', description: 'Literature, Writing, and Grammar', progress: 0, lessons: 0, planningData: {} },
            { id: 4, name: 'History', emoji: '🏛️', description: 'World History and Geography', progress: 0, lessons: 0, planningData: {} },
            { id: 5, name: 'Art', emoji: '🎨', description: 'Drawing, Painting, and Creative Expression', progress: 0, lessons: 0, planningData: {} },
            { id: 6, name: 'Music', emoji: '🎵', description: 'Theory, Practice, and Appreciation', progress: 0, lessons: 0, planningData: {} }
        ];

        let lessons = [
            // Lessons will be added dynamically and progress calculated from actual data
        ];

        // Auto-save functions
        function createSaveIndicator() {
            if (saveIndicator) return;
            
            saveIndicator = document.createElement('div');
            saveIndicator.id = 'saveIndicator';
            saveIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(16, 185, 129, 0.95);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.85rem;
                font-weight: 600;
                z-index: 1001;
                display: none;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            `;
            saveIndicator.innerHTML = '💾 Saving...';
            document.body.appendChild(saveIndicator);
        }

        function showSaveIndicator(message = '💾 Saving...', color = 'rgba(16, 185, 129, 0.95)') {
            if (!saveIndicator) createSaveIndicator();
            
            saveIndicator.innerHTML = message;
            saveIndicator.style.background = color;
            saveIndicator.style.display = 'block';
            
            setTimeout(() => {
                if (saveIndicator) {
                    saveIndicator.style.display = 'none';
                }
            }, 2000);
        }

        function autoSave() {
            const appData = {
                subjects: subjects,
                lessons: lessons,
                formData: {
                    learnerName: document.getElementById('learnerName')?.value || '',
                    teacherName: document.getElementById('teacherName')?.value || '',
                    globalCountryRegion: document.getElementById('globalCountryRegion')?.value || 'us',
                    globalCalendarSystem: document.getElementById('globalCalendarSystem')?.value || 'quarterly',
                    globalSchoolYearStart: document.getElementById('globalSchoolYearStart')?.value || '',
                    globalAcademicYear: document.getElementById('globalAcademicYear')?.value || '',
                    globalGradeLevel: document.getElementById('globalGradeLevel')?.value || '',
                    globalInterfaceLanguage: document.getElementById('globalInterfaceLanguage')?.value || 'en'
                },
                planningData: {
                    learningGoals: document.getElementById('learningGoals')?.value || '',
                    prerequisites: document.getElementById('prerequisites')?.value || '',
                    teachingNotes: document.getElementById('teachingNotes')?.value || '',
                    mappingInsights: document.getElementById('mappingInsights')?.value || '',
                    subjectSelect: document.getElementById('subjectSelect')?.value || '',
                    subjectFocus: document.getElementById('subjectFocus')?.value || 'unit'
                },
                tableData: {
                    monthlyPlan: getTableData('monthlyPlanTable'),
                    weeklyPlan: getTableData('weeklyPlanTable'),
                    schedule: getTableData('scheduleTable')
                },
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            try {
                localStorage.setItem('eduflow_autosave', JSON.stringify(appData));
                lastSaveTime = new Date();
                showSaveIndicator('✅ Saved', 'rgba(16, 185, 129, 0.95)');
                console.log('Auto-saved at:', lastSaveTime.toLocaleTimeString());
            } catch (error) {
                console.error('Auto-save failed:', error);
                showSaveIndicator('❌ Save Failed', 'rgba(239, 68, 68, 0.95)');
            }
        }

        function getTableData(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return [];
            
            const rows = table.querySelectorAll('tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    const input = cell.querySelector('input, textarea, select');
                    rowData.push(input ? input.value : cell.textContent.trim());
                });
                if (rowData.length > 0) data.push(rowData);
            });
            
            return data;
        }

        function restoreTableData(tableId, data) {
            const table = document.getElementById(tableId);
            if (!table || !data || data.length === 0) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            data.forEach(rowData => {
                if (tableId === 'monthlyPlanTable') {
                    addMonthlyRow(rowData[0] || '', rowData[1] || '');
                    // Restore cell values
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (index < rowData.length) {
                                const input = cell.querySelector('input, textarea');
                                if (input && rowData[index]) {
                                    input.value = rowData[index];
                                }
                            }
                        });
                    }
                } else if (tableId === 'weeklyPlanTable') {
                    addSubjectRow(rowData[0] || '', rowData[1] || '');
                    // Restore cell values
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (index < rowData.length) {
                                const input = cell.querySelector('input, textarea');
                                if (input && rowData[index]) {
                                    input.value = rowData[index];
                                }
                            }
                        });
                    }
                } else if (tableId === 'scheduleTable') {
                    addTimeSlot(rowData[0] || '');
                    // Restore cell values
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (index < rowData.length) {
                                const input = cell.querySelector('input, textarea, select');
                                if (input && rowData[index]) {
                                    input.value = rowData[index];
                                }
                            }
                        });
                    }
                }
            });
        }

        function triggerAutoSave() {
            // Clear existing timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            // Show saving indicator immediately
            showSaveIndicator('💾 Saving...', 'rgba(59, 130, 246, 0.95)');
            
            // Set new timer for 1 second delay
            autoSaveTimer = setTimeout(() => {
                autoSave();
            }, 1000);
        }

        function loadAutoSavedData() {
            try {
                const savedData = localStorage.getItem('eduflow_autosave');
                if (!savedData) return false;
                
                const data = JSON.parse(savedData);
                
                // Restore subjects and lessons
                if (data.subjects) subjects = data.subjects;
                if (data.lessons) lessons = data.lessons;
                
                // Restore form data
                if (data.formData) {
                    Object.keys(data.formData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && data.formData[key]) {
                            element.value = data.formData[key];
                        }
                    });
                }
                
                // Restore planning data
                if (data.planningData) {
                    Object.keys(data.planningData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && data.planningData[key]) {
                            element.value = data.planningData[key];
                        }
                    });
                }
                
                // Restore table data
                if (data.tableData) {
                    setTimeout(() => {
                        if (data.tableData.monthlyPlan) restoreTableData('monthlyPlanTable', data.tableData.monthlyPlan);
                        if (data.tableData.weeklyPlan) restoreTableData('weeklyPlanTable', data.tableData.weeklyPlan);
                        if (data.tableData.schedule) restoreTableData('scheduleTable', data.tableData.schedule);
                    }, 500);
                }
                
                lastSaveTime = new Date(data.timestamp);
                console.log('Data restored from auto-save:', lastSaveTime.toLocaleTimeString());
                showSaveIndicator('✅ Data Restored', 'rgba(16, 185, 129, 0.95)');
                return true;
            } catch (error) {
                console.error('Failed to load auto-saved data:', error);
                return false;
            }
        }

        function setupAutoSaveListeners() {
            // Add listeners to all form inputs
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('input', triggerAutoSave);
                input.addEventListener('change', triggerAutoSave);
            });
            
            // Add listeners to dynamically created elements
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, textarea, select')) {
                    triggerAutoSave();
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.matches('input, textarea, select')) {
                    triggerAutoSave();
                }
            });
        }

        // Global curriculum data
        let globalCurricula = {
            'us': {
                name: '🇺🇸 United States',
                standards: 'Common Core State Standards',
                subjects: ['Mathematics', 'English Language Arts', 'Science', 'Social Studies', 'Physical Education', 'Arts'],
                gradeLevels: ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                calendarSystems: ['semester', 'quarterly', 'trimester'],
                standardSemesters: 2
            },
            'uk': {
                name: '🇬🇧 United Kingdom',
                standards: 'National Curriculum for England',
                subjects: ['Mathematics', 'English', 'Science', 'History', 'Geography', 'Art & Design', 'Music', 'PE', 'Computing'],
                gradeLevels: ['Reception', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7', 'Year 8', 'Year 9', 'Year 10', 'Year 11'],
                calendarSystems: ['termly', 'half-termly', 'yearly'],
                standardSemesters: 3
            },
            'ca': {
                name: '🇨🇦 Canada',
                standards: 'Provincial Curriculum Standards',
                subjects: ['Mathematics', 'Language Arts', 'Science', 'Social Studies', 'Health & Career Education', 'Arts Education', 'Physical Education'],
                gradeLevels: ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                calendarSystems: ['semester', 'quarterly', 'linear'],
                standardSemesters: 2
            },
            'au': {
                name: '🇦🇺 Australia',
                standards: 'Australian Curriculum',
                subjects: ['Mathematics', 'English', 'Science', 'Humanities & Social Sciences', 'Health & Physical Education', 'The Arts', 'Technologies'],
                gradeLevels: ['Foundation', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7', 'Year 8', 'Year 9', 'Year 10', 'Year 11', 'Year 12'],
                calendarSystems: ['termly', 'semester', 'yearly'],
                standardSemesters: 4
            },
            'nz': {
                name: '🇳🇿 New Zealand',
                standards: 'New Zealand Curriculum',
                subjects: ['Mathematics', 'English', 'Science', 'Social Sciences', 'Health & Physical Education', 'The Arts', 'Technology'],
                gradeLevels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7', 'Year 8', 'Year 9', 'Year 10', 'Year 11', 'Year 12', 'Year 13'],
                calendarSystems: ['termly', 'semester', 'yearly'],
                standardSemesters: 4
            },
            'sg': {
                name: '🇸🇬 Singapore',
                standards: 'Singapore Curriculum',
                subjects: ['Mathematics', 'English Language', 'Science', 'Social Studies', 'Mother Tongue', 'Physical Education', 'Arts'],
                gradeLevels: ['Primary 1', 'Primary 2', 'Primary 3', 'Primary 4', 'Primary 5', 'Primary 6', 'Secondary 1', 'Secondary 2', 'Secondary 3', 'Secondary 4'],
                calendarSystems: ['semester', 'termly', 'yearly'],
                standardSemesters: 2
            },
            'in': {
                name: '🇮🇳 India',
                standards: 'NCERT/CBSE Curriculum',
                subjects: ['Mathematics', 'English', 'Hindi', 'Science', 'Social Science', 'Physical Education', 'Arts'],
                gradeLevels: ['Class 1', 'Class 2', 'Class 3', 'Class 4', 'Class 5', 'Class 6', 'Class 7', 'Class 8', 'Class 9', 'Class 10', 'Class 11', 'Class 12'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'de': {
                name: '🇩🇪 Germany',
                standards: 'German Education Standards',
                subjects: ['Mathematik', 'Deutsch', 'Sachunterricht', 'Englisch', 'Geschichte', 'Erdkunde', 'Kunst', 'Musik', 'Sport'],
                gradeLevels: ['Klasse 1', 'Klasse 2', 'Klasse 3', 'Klasse 4', 'Klasse 5', 'Klasse 6', 'Klasse 7', 'Klasse 8', 'Klasse 9', 'Klasse 10', 'Klasse 11', 'Klasse 12'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'fr': {
                name: '🇫🇷 France',
                standards: 'French National Education',
                subjects: ['Mathématiques', 'Français', 'Sciences', 'Histoire-Géographie', 'Éducation Physique', 'Arts Plastiques', 'Musique'],
                gradeLevels: ['CP', 'CE1', 'CE2', 'CM1', 'CM2', '6ème', '5ème', '4ème', '3ème', '2nde', '1ère', 'Terminale'],
                calendarSystems: ['trimester', 'semester', 'yearly'],
                standardSemesters: 3
            },
            'jp': {
                name: '🇯🇵 Japan',
                standards: 'Japanese Course of Study',
                subjects: ['算数/数学', '国語', '理科', '社会', '体育', '音楽', '図画工作/美術', '英語'],
                gradeLevels: ['小1', '小2', '小3', '小4', '小5', '小6', '中1', '中2', '中3', '高1', '高2', '高3'],
                calendarSystems: ['trimester', 'semester', 'yearly'],
                standardSemesters: 3
            },
            'cn': {
                name: '🇨🇳 China',
                standards: 'Chinese National Curriculum',
                subjects: ['数学', '语文', '英语', '科学', '历史', '地理', '体育', '美术', '音乐'],
                gradeLevels: ['一年级', '二年级', '三年级', '四年级', '五年级', '六年级', '七年级', '八年级', '九年级', '高一', '高二', '高三'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'kr': {
                name: '🇰🇷 South Korea',
                standards: 'Korean National Curriculum',
                subjects: ['수학', '국어', '영어', '과학', '사회', '체육', '음악', '미술'],
                gradeLevels: ['초1', '초2', '초3', '초4', '초5', '초6', '중1', '중2', '중3', '고1', '고2', '고3'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'th': {
                name: '🇹🇭 Thailand',
                standards: 'Thai Basic Education Core Curriculum',
                subjects: ['คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'วิทยาศาสตร์', 'สังคมศึกษา', 'พลศึกษา', 'ศิลปะ'],
                gradeLevels: ['ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6', 'ม.1', 'ม.2', 'ม.3', 'ม.4', 'ม.5', 'ม.6'],
                calendarSystems: ['semester', 'trimester', 'yearly'],
                standardSemesters: 2
            },
            'my': {
                name: '🇲🇾 Malaysia',
                standards: 'Malaysian National Curriculum',
                subjects: ['Matematik', 'Bahasa Malaysia', 'English', 'Science', 'Sejarah', 'Geografi', 'Pendidikan Jasmani', 'Seni'],
                gradeLevels: ['Tahun 1', 'Tahun 2', 'Tahun 3', 'Tahun 4', 'Tahun 5', 'Tahun 6', 'Tingkatan 1', 'Tingkatan 2', 'Tingkatan 3', 'Tingkatan 4', 'Tingkatan 5'],
                calendarSystems: ['semester', 'termly', 'yearly'],
                standardSemesters: 2
            },
            'ph': {
                name: '🇵🇭 Philippines',
                standards: 'K to 12 Basic Education Curriculum',
                subjects: ['Mathematics', 'Filipino', 'English', 'Science', 'Araling Panlipunan', 'MAPEH', 'TLE'],
                gradeLevels: ['Kinder', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                calendarSystems: ['quarterly', 'semester', 'yearly'],
                standardSemesters: 4
            },
            'id': {
                name: '🇮🇩 Indonesia',
                standards: 'Indonesian National Curriculum',
                subjects: ['Matematika', 'Bahasa Indonesia', 'Bahasa Inggris', 'IPA', 'IPS', 'Pendidikan Jasmani', 'Seni Budaya'],
                gradeLevels: ['Kelas 1', 'Kelas 2', 'Kelas 3', 'Kelas 4', 'Kelas 5', 'Kelas 6', 'Kelas 7', 'Kelas 8', 'Kelas 9', 'Kelas 10', 'Kelas 11', 'Kelas 12'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'ae': {
                name: '🇦🇪 UAE',
                standards: 'UAE National Curriculum',
                subjects: ['Mathematics', 'Arabic', 'English', 'Science', 'Social Studies', 'Islamic Studies', 'Physical Education', 'Arts'],
                gradeLevels: ['KG1', 'KG2', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                calendarSystems: ['semester', 'trimester', 'yearly'],
                standardSemesters: 2
            },
            'sa': {
                name: '🇸🇦 Saudi Arabia',
                standards: 'Saudi National Curriculum',
                subjects: ['الرياضيات', 'اللغة العربية', 'اللغة الإنجليزية', 'العلوم', 'الدراسات الاجتماعية', 'التربية الإسلامية', 'التربية البدنية', 'الفنون'],
                gradeLevels: ['الصف الأول', 'الصف الثاني', 'الصف الثالث', 'الصف الرابع', 'الصف الخامس', 'الصف السادس', 'الصف السابع', 'الصف الثامن', 'الصف التاسع', 'الصف العاشر', 'الصف الحادي عشر', 'الصف الثاني عشر'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'qa': {
                name: '🇶🇦 Qatar',
                standards: 'Qatar National Curriculum',
                subjects: ['Mathematics', 'Arabic', 'English', 'Science', 'Social Studies', 'Islamic Studies', 'Physical Education', 'Arts'],
                gradeLevels: ['Foundation', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                calendarSystems: ['semester', 'trimester', 'yearly'],
                standardSemesters: 2
            },
            'tr': {
                name: '🇹🇷 Turkey',
                standards: 'Turkish National Curriculum',
                subjects: ['Matematik', 'Türkçe', 'İngilizce', 'Fen Bilimleri', 'Sosyal Bilgiler', 'Beden Eğitimi', 'Sanat'],
                gradeLevels: ['1. Sınıf', '2. Sınıf', '3. Sınıf', '4. Sınıf', '5. Sınıf', '6. Sınıf', '7. Sınıf', '8. Sınıf', '9. Sınıf', '10. Sınıf', '11. Sınıf', '12. Sınıf'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            }
        };

        // Calendar system configurations
        let calendarConfigs = {
            'quarterly': { periods: 4, name: 'Quarter', duration: '3 months' },
            'semester': { periods: 2, name: 'Semester', duration: '6 months' },
            'trimester': { periods: 3, name: 'Trimester', duration: '4 months' },
            'termly': { periods: 3, name: 'Term', duration: '4 months' },
            'half-termly': { periods: 6, name: 'Half-Term', duration: '2 months' },
            'monthly': { periods: 12, name: 'Month', duration: '1 month' },
            'linear': { periods: 1, name: 'Full Year', duration: '10 months' },
            'yearly': { periods: 1, name: 'Academic Year', duration: '10 months' }
        };

        // Navigation functions
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(viewName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load view-specific content
            if (viewName === 'subjects') {
                loadSubjects();
            } else if (viewName === 'planner') {
                initializePlannerTables();
                populateLessonSubjects();
            } else if (viewName === 'schedule') {
                loadScheduleTemplate();
            } else if (viewName === 'progress') {
                loadProgressCharts();
                loadMilestones();
            } else if (viewName === 'overview') {
                updateOverviewStats();
            }
        }

        // Planner view navigation
        function showPlannerView(viewName) {
            // Hide all planner views
            document.querySelectorAll('.planner-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Remove active class from all planner tabs
            document.querySelectorAll('.planner-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected planner view
            document.getElementById(viewName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Initialize tables based on view
            if (viewName === 'subject-wise') {
                initializeMonthlyPlanTable();
            } else if (viewName === 'period-wise') {
                initializeWeeklyPlanTable();
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Subject management
        function loadSubjects() {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = '';
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <h3>${subject.emoji} ${subject.name}</h3>
                    <p>${subject.description}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${subject.progress}%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                        <small style="color: #6b7280;">${subject.progress}% Complete • ${subject.lessons} lessons</small>
                        <button class="btn btn-danger" onclick="deleteSubject(${subject.id})" style="padding: 6px 12px; font-size: 0.8rem;">
                            🗑️ Delete
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function addSubject(event) {
            event.preventDefault();
            
            const name = document.getElementById('subjectName').value;
            const emoji = document.getElementById('subjectEmoji').value || '📚';
            const description = document.getElementById('subjectDescription').value;
            
            const newSubject = {
                id: Date.now(),
                name,
                emoji,
                description,
                progress: 0,
                lessons: 0,
                planningData: {}
            };
            
            subjects.push(newSubject);
            closeModal('addSubjectModal');
            
            // Reset form
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectEmoji').value = '';
            document.getElementById('subjectDescription').value = '';
            
            // Update all interconnected sections
            updateAllSections();
        }

        // Update all sections when data changes
        function updateAllSections() {
            updateOverviewStats();
            if (document.getElementById('subjects').classList.contains('active')) {
                loadSubjects();
            }
            populateLessonSubjects();
            updateSubjectDropdown();
        }

        // Update subject dropdown in planner
        function updateSubjectDropdown() {
            const select = document.getElementById('subjectSelect');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Subject</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.emoji} ${subject.name}`;
                select.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Update subject title when selection changes
        function updateSubjectTitle() {
            const subjectId = document.getElementById('subjectSelect').value;
            const titleElement = document.getElementById('monthlyPlanningTitle');
            
            if (!titleElement) return;
            
            if (subjectId) {
                const subject = subjects.find(s => s.id == subjectId);
                if (subject) {
                    titleElement.textContent = `${subject.emoji} ${subject.name} Monthly Curriculum Planning`;
                } else {
                    titleElement.textContent = 'Monthly Curriculum Planning';
                }
            } else {
                titleElement.textContent = 'Monthly Curriculum Planning';
            }
        }

        // Update calendar table based on global settings
        function updateCalendarTable() {
            const calendarSystem = document.getElementById('globalCalendarSystem').value;
            const config = calendarConfigs[calendarSystem];
            
            if (!config) return;
            
            // Clear existing table
            const tableBody = document.getElementById('monthlyPlanTable');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Update weekly table headers based on calendar system
            updateWeeklyTableHeaders(calendarSystem);
            
            // Get school year start month from global settings
            const schoolYearStart = document.getElementById('globalSchoolYearStart').value;
            let startMonth = 8; // Default to September (month 8)
            if (schoolYearStart) {
                startMonth = parseInt(schoolYearStart.split('-')[1]) - 1; // Convert to 0-based month
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Add rows based on calendar system with detailed month breakdowns
            for (let i = 1; i <= config.periods; i++) {
                let periodName = '';
                let months = '';
                
                if (calendarSystem === 'quarterly') {
                    periodName = `Quarter ${i}`;
                    // Calculate months for each quarter based on start month
                    const quarterStartMonth = (startMonth + (i - 1) * 3) % 12;
                    const month1 = monthNames[quarterStartMonth];
                    const month2 = monthNames[(quarterStartMonth + 1) % 12];
                    const month3 = monthNames[(quarterStartMonth + 2) % 12];
                    months = `${month1}, ${month2}, ${month3}`;
                } else if (calendarSystem === 'semester') {
                    periodName = `Semester ${i}`;
                    if (i === 1) {
                        const semesterStartMonth = startMonth;
                        const monthsInSemester = [];
                        for (let j = 0; j < 6; j++) {
                            monthsInSemester.push(monthNames[(semesterStartMonth + j) % 12]);
                        }
                        months = monthsInSemester.join(', ');
                    } else {
                        const semesterStartMonth = (startMonth + 6) % 12;
                        const monthsInSemester = [];
                        for (let j = 0; j < 6; j++) {
                            monthsInSemester.push(monthNames[(semesterStartMonth + j) % 12]);
                        }
                        months = monthsInSemester.join(', ');
                    }
                } else if (calendarSystem === 'trimester') {
                    periodName = `Trimester ${i}`;
                    const trimesterStartMonth = (startMonth + (i - 1) * 4) % 12;
                    const month1 = monthNames[trimesterStartMonth];
                    const month2 = monthNames[(trimesterStartMonth + 1) % 12];
                    const month3 = monthNames[(trimesterStartMonth + 2) % 12];
                    const month4 = monthNames[(trimesterStartMonth + 3) % 12];
                    months = `${month1}, ${month2}, ${month3}, ${month4}`;
                } else if (calendarSystem === 'monthly') {
                    const monthIndex = (startMonth + i - 1) % 12;
                    periodName = monthNames[monthIndex];
                    months = monthNames[monthIndex];
                }
                
                addMonthlyRow(periodName, months);
            }
        }

        // Update weekly table headers based on calendar system
        function updateWeeklyTableHeaders(calendarSystem) {
            const config = calendarConfigs[calendarSystem];
            if (!config) return;
            
            // Calculate weeks per period based on calendar system
            let weeksPerPeriod;
            switch(calendarSystem) {
                case 'quarterly':
                    weeksPerPeriod = 9; // 9 weeks per quarter
                    break;
                case 'semester':
                    weeksPerPeriod = 18; // 18 weeks per semester
                    break;
                case 'trimester':
                    weeksPerPeriod = 12; // 12 weeks per trimester
                    break;
                case 'monthly':
                    weeksPerPeriod = 4; // 4 weeks per month
                    break;
                default:
                    weeksPerPeriod = 12;
            }
            
            // Limit to maximum 12 columns for display
            const displayWeeks = Math.min(weeksPerPeriod, 12);
            
            // Update header labels and visibility
            for (let i = 1; i <= 12; i++) {
                const header = document.getElementById(`week${i}Header`);
                if (header) {
                    if (i <= displayWeeks) {
                        header.textContent = `Week ${i}`;
                        header.style.display = 'table-cell';
                    } else {
                        header.style.display = 'none';
                    }
                }
            }
            
            // Update existing table rows to show/hide cells
            const tableBody = document.getElementById('weeklyPlanTable');
            if (tableBody) {
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Skip first 2 cells (subject and textbook), then handle week cells
                    for (let i = 2; i < cells.length && i < 14; i++) {
                        const weekIndex = i - 1; // Week 1 starts at index 2, so week number is i-1
                        if (weekIndex <= displayWeeks) {
                            cells[i].style.display = 'table-cell';
                        } else {
                            cells[i].style.display = 'none';
                        }
                    }
                });
            }
        }

        // Global calendar configuration functions
        function updateGlobalCountrySettings() {
            const country = document.getElementById('globalCountryRegion').value;
            const curriculum = globalCurricula[country];
            
            if (!curriculum) return;
            
            // Update global calendar system options based on country
            const calendarSelect = document.getElementById('globalCalendarSystem');
            calendarSelect.innerHTML = '';
            
            curriculum.calendarSystems.forEach(system => {
                const config = calendarConfigs[system];
                if (config) {
                    const option = document.createElement('option');
                    option.value = system;
                    option.textContent = `${config.name} (${config.periods} periods - ${config.duration})`;
                    calendarSelect.appendChild(option);
                }
            });
            
            // Set default to quarterly for Philippines
            if (country === 'ph') {
                calendarSelect.value = 'quarterly';
            }
            
            // Update period dropdown based on first calendar system
            if (curriculum.calendarSystems.length > 0) {
                const selectedSystem = country === 'ph' ? 'quarterly' : curriculum.calendarSystems[0];
                updateGlobalPeriodDropdown(selectedSystem);
            }
            
            // Show global curriculum info
            showGlobalCurriculumInfo(curriculum);
            
            // Update calendar table with new system
            updateCalendarTable();
            
            // Sync to individual view dropdowns
            syncToIndividualViews();
        }

        function updateAcademicYearFromStart() {
            const schoolYearStart = document.getElementById('globalSchoolYearStart').value;
            const academicYearSelect = document.getElementById('globalAcademicYear');
            
            if (!schoolYearStart) return;
            
            const startYear = parseInt(schoolYearStart.split('-')[0]);
            const startMonth = parseInt(schoolYearStart.split('-')[1]);
            
            // Academic year spans two calendar years if it starts in August or later
            let academicYear;
            if (startMonth >= 8) {
                academicYear = `${startYear}-${startYear + 1}`;
            } else {
                academicYear = `${startYear - 1}-${startYear}`;
            }
            
            // Update the academic year dropdown
            academicYearSelect.innerHTML = '';
            for (let i = -1; i <= 2; i++) {
                const year = startYear + i;
                const yearOption = startMonth >= 8 ? `${year}-${year + 1}` : `${year - 1}-${year}`;
                const option = document.createElement('option');
                option.value = yearOption;
                option.textContent = yearOption;
                if (yearOption === academicYear) {
                    option.selected = true;
                }
                academicYearSelect.appendChild(option);
            }
            
            // Update header info
            updateHeaderInfo();
        }

        function updateGlobalCalendarSystem() {
            const calendarSystem = document.getElementById('globalCalendarSystem').value;
            const config = calendarConfigs[calendarSystem];
            
            if (!config) return;
            
            // Update period dropdown
            updateGlobalPeriodDropdown(calendarSystem);
            
            // Update calendar table
            updateCalendarTable();
            
            // Update academic year based on school year start
            updateAcademicYearFromStart();
            
            // Sync to individual views
            syncToIndividualViews();
        }

        function updateGlobalPeriodDropdown(calendarSystem) {
            const config = calendarConfigs[calendarSystem];
            const periodSelect = document.getElementById('periodSelect');
            const periodLabel = document.getElementById('periodLabel');
            
            if (!config || !periodSelect) return;
            
            periodLabel.textContent = `📅 Select ${config.name} to Plan`;
            periodSelect.innerHTML = '';
            
            for (let i = 1; i <= config.periods; i++) {
                const option = document.createElement('option');
                option.value = `p${i}`;
                option.textContent = `${config.name} ${i}`;
                periodSelect.appendChild(option);
            }
        }

        function showGlobalCurriculumInfo(curriculum) {
            const infoDiv = document.getElementById('globalCurriculumInfo');
            const standardsP = document.getElementById('globalCurriculumStandards');
            
            if (infoDiv && standardsP) {
                standardsP.textContent = `${curriculum.name} - ${curriculum.standards}`;
                infoDiv.style.display = 'block';
            }
        }

        function syncToIndividualViews() {
            // Sync global settings to individual view elements
            const globalCountry = document.getElementById('globalCountryRegion').value;
            const globalCalendar = document.getElementById('globalCalendarSystem').value;
            const globalYear = document.getElementById('globalAcademicYear').value;
            const globalGrade = document.getElementById('globalGradeLevel').value;
            const globalYearStart = document.getElementById('globalSchoolYearStart').value;
            
            // Update subject-wise view elements if they exist
            const gradeLevel = document.getElementById('gradeLevel');
            const schoolYearStart = document.getElementById('schoolYearStart');
            const calendarSystem = document.getElementById('calendarSystem');
            
            if (gradeLevel) gradeLevel.value = globalGrade;
            if (schoolYearStart) schoolYearStart.value = globalYearStart;
            if (calendarSystem) calendarSystem.value = globalCalendar;
            
            // Update period-wise view elements if they exist
            const countryRegion = document.getElementById('countryRegion');
            const academicYear = document.getElementById('academicYear');
            
            if (countryRegion) countryRegion.value = globalCountry;
            if (academicYear) academicYear.value = globalYear;
        }

        // Update country-based options (legacy function for compatibility)
        function updateCountryBasedOptions() {
            // This function is now handled by the global configuration
            console.log('Using global country configuration');
        }

        // Update period dropdown based on calendar system
        function updatePeriodDropdown(calendarSystem) {
            const config = calendarConfigs[calendarSystem];
            const periodLabel = document.getElementById('periodLabel');
            const quarterSelect = document.getElementById('quarterSelect');
            
            if (!config) return;
            
            periodLabel.textContent = config.name;
            quarterSelect.innerHTML = '';
            
            for (let i = 1; i <= config.periods; i++) {
                const option = document.createElement('option');
                option.value = `p${i}`;
                option.textContent = `${config.name} ${i}`;
                quarterSelect.appendChild(option);
            }
        }

        // Show curriculum information
        function showCurriculumInfo(curriculum) {
            const infoDiv = document.getElementById('curriculumInfo');
            const standardsP = document.getElementById('curriculumStandards');
            
            if (infoDiv && standardsP) {
                standardsP.textContent = `${curriculum.name} - ${curriculum.standards}`;
                infoDiv.style.display = 'block';
            }
            
            console.log(`Using ${curriculum.name} curriculum with ${curriculum.standards}`);
        }

        function deleteSubject(id) {
            if (confirm('Are you sure you want to delete this subject? This will also remove all associated lessons.')) {
                // Remove subject
                subjects = subjects.filter(subject => subject.id !== id);
                
                // Remove associated lessons
                lessons = lessons.filter(lesson => lesson.subjectId !== id);
                
                // Update all interconnected sections
                updateAllSections();
            }
        }

        // Lesson management
        function populateLessonSubjects() {
            const select = document.getElementById('lessonSubject');
            select.innerHTML = '<option value="">Select a subject</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.emoji} ${subject.name}`;
                select.appendChild(option);
            });
        }

        function addLesson(event) {
            event.preventDefault();
            
            const subjectId = parseInt(document.getElementById('lessonSubject').value);
            const title = document.getElementById('lessonTitle').value;
            const date = document.getElementById('lessonDate').value;
            const duration = parseInt(document.getElementById('lessonDuration').value);
            
            const newLesson = {
                id: Date.now(),
                subjectId,
                title,
                date,
                duration,
                status: 'not-started'
            };
            
            lessons.push(newLesson);
            
            // Update subject lesson count and progress
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                subject.lessons += 1;
                // Recalculate progress based on completed lessons
                const subjectLessons = lessons.filter(l => l.subjectId === subjectId);
                const completedLessons = subjectLessons.filter(l => l.status === 'completed');
                subject.progress = subjectLessons.length > 0 ? Math.round((completedLessons.length / subjectLessons.length) * 100) : 0;
            }
            
            closeModal('addLessonModal');
            
            // Reset form
            document.getElementById('lessonSubject').value = '';
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonDate').value = '';
            document.getElementById('lessonDuration').value = '60';
            
            // Update all interconnected sections
            updateAllSections();
        }

        // Update lesson status and recalculate progress
        function updateLessonStatus(lessonId, newStatus) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                lesson.status = newStatus;
                
                // Update subject progress
                const subject = subjects.find(s => s.id === lesson.subjectId);
                if (subject) {
                    const subjectLessons = lessons.filter(l => l.subjectId === lesson.subjectId);
                    const completedLessons = subjectLessons.filter(l => l.status === 'completed');
                    subject.progress = subjectLessons.length > 0 ? Math.round((completedLessons.length / subjectLessons.length) * 100) : 0;
                }
                
                updateAllSections();
            }
        }



        // Planner table management
        function initializePlannerTables() {
            initializeMonthlyPlanTable();
            initializeWeeklyPlanTable();
        }

        function initializeMonthlyPlanTable() {
            const tableBody = document.getElementById('monthlyPlanTable');
            if (tableBody.children.length === 0) {
                // Add sample rows
                addMonthlyRow('September 2024');
                addMonthlyRow('October 2024');
                addMonthlyRow('November 2024');
            }
        }

        function addMonthlyRow(timePeriod = '', months = '') {
            const tableBody = document.getElementById('monthlyPlanTable');
            const row = document.createElement('tr');
            
            // Create clean spacing based on the months string
            let monthLines = '';
            let monthInputs = '';
            if (months) {
                const monthArray = months.split(', ');
                monthLines = monthArray.map(month => `<div style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; min-height: 40px; font-size: 0.85rem; color: #374151; font-weight: 500;">${month}</div>`).join('');
                
                // Create individual input boxes with clean spacing for each month
                monthInputs = monthArray.map((month, index) => 
                    `<div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 60px;">
                        <textarea placeholder="${month} content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 40px; padding: 2px; font-size: 0.85rem;"></textarea>
                    </div>`
                ).join('');
            } else {
                monthLines = '<div style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; min-height: 40px; font-size: 0.85rem; color: #374151; font-weight: 500;">Month 1</div><div style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; min-height: 40px; font-size: 0.85rem; color: #374151; font-weight: 500;">Month 2</div><div style="padding: 12px 8px; min-height: 40px; font-size: 0.85rem; color: #374151; font-weight: 500;">Month 3</div>';
                
                monthInputs = `
                    <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 60px;">
                        <textarea placeholder="Month 1 content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 40px; padding: 2px; font-size: 0.85rem;"></textarea>
                    </div>
                    <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 60px;">
                        <textarea placeholder="Month 2 content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 40px; padding: 2px; font-size: 0.85rem;"></textarea>
                    </div>
                    <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 60px;">
                        <textarea placeholder="Month 3 content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 40px; padding: 2px; font-size: 0.85rem;"></textarea>
                    </div>
                `;
            }
            
            // Calculate row height based on number of months
            const monthCount = months ? months.split(', ').length : 3;
            const rowHeight = Math.max(180, monthCount * 60);
            
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top;">
                    <input type="text" value="${timePeriod}" placeholder="Quarter/Period" style="width: 100%; border: none; background: transparent; padding: 4px; font-weight: 600;">
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-width: 120px;">
                    <div>
                        ${monthLines}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: ${rowHeight}px;">
                    ${monthInputs}
                </td>
            `;
            
            tableBody.appendChild(row);
        }

        function initializeWeeklyPlanTable() {
            const tableBody = document.getElementById('weeklyPlanTable');
            if (tableBody.children.length === 0) {
                // Add sample rows for each subject
                const sampleSubjects = [
                    { name: '🔢 Mathematics', textbook: 'Saxon Math 7/6' },
                    { name: '🔬 Science', textbook: 'Apologia General Science' },
                    { name: '📝 English', textbook: 'IEW Student Writing Intensive' },
                    { name: '🏛️ History', textbook: 'Story of the World Vol. 3' }
                ];
                
                sampleSubjects.forEach(subject => {
                    addSubjectRow(subject.name, subject.textbook);
                });
            }
        }

        function addSubjectRow(subjectName = '', textbook = '') {
            const tableBody = document.getElementById('weeklyPlanTable');
            const row = document.createElement('tr');
            
            // Get current calendar system to determine number of weeks to show
            const calendarSystem = document.getElementById('globalCalendarSystem')?.value || 'quarterly';
            let weeksToShow;
            switch(calendarSystem) {
                case 'quarterly':
                    weeksToShow = 9;
                    break;
                case 'semester':
                    weeksToShow = 12; // Show 12 weeks max for semester (18 is too many columns)
                    break;
                case 'trimester':
                    weeksToShow = 12;
                    break;
                case 'monthly':
                    weeksToShow = 4;
                    break;
                default:
                    weeksToShow = 12;
            }
            
            let weekCells = '';
            for (let i = 1; i <= 12; i++) {
                const displayStyle = i <= weeksToShow ? 'table-cell' : 'none';
                weekCells += `
                    <td style="padding: 8px; border: 1px solid #e5e7eb; display: ${displayStyle};">
                        <textarea placeholder="Week ${i} content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px; font-size: 0.8rem;"></textarea>
                    </td>
                `;
            }
            
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <input type="text" value="${subjectName}" placeholder="Subject" style="width: 100%; border: none; background: transparent; padding: 4px; font-weight: 600;">
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <input type="text" value="${textbook}" placeholder="Textbook/Resource" style="width: 100%; border: none; background: transparent; padding: 4px;">
                </td>
                ${weekCells}
            `;
            
            tableBody.appendChild(row);
        }

        // Add a new column to the monthly planning table
        function addColumnToTable() {
            const table = document.querySelector('#monthlyPlanTable').closest('table');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');
            
            // Add header
            const newHeader = document.createElement('th');
            newHeader.style.cssText = 'padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;';
            newHeader.textContent = 'Custom Column';
            headerRow.appendChild(newHeader);
            
            // Add cells to existing rows
            bodyRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.style.cssText = 'padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: 180px;';
                
                // Get the number of months from the second cell
                const monthsCell = row.cells[1];
                const monthCount = monthsCell ? monthsCell.querySelectorAll('div').length : 3;
                
                let monthInputs = '';
                for (let i = 1; i <= monthCount; i++) {
                    monthInputs += `
                        <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 60px;">
                            <textarea placeholder="Month ${i} content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 40px; padding: 2px; font-size: 0.85rem;"></textarea>
                        </div>
                    `;
                }
                
                newCell.innerHTML = monthInputs;
                row.appendChild(newCell);
            });
            
            alert('✅ New column added! You can edit the header by clicking on it.');
        }

        // Add a new week column to the weekly planning table
        function addWeekColumn() {
            const table = document.querySelector('#weeklyPlanTable').closest('table');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');
            
            // Find the next week number
            const existingWeekHeaders = Array.from(headerRow.querySelectorAll('th')).slice(2); // Skip first 2 columns
            const visibleWeeks = existingWeekHeaders.filter(th => th.style.display !== 'none').length;
            const nextWeekNumber = visibleWeeks + 1;
            
            // Check if we can show an existing hidden week first
            for (let i = 1; i <= 12; i++) {
                const header = document.getElementById(`week${i}Header`);
                if (header && header.style.display === 'none') {
                    header.style.display = 'table-cell';
                    
                    // Show corresponding cells in all rows
                    bodyRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells[i + 1]) { // +1 because first 2 cells are subject and textbook
                            cells[i + 1].style.display = 'table-cell';
                        }
                    });
                    
                    alert(`✅ Week ${i} column is now visible!`);
                    return;
                }
            }
            
            // If all 12 weeks are visible, add a new column beyond the standard 12
            const newHeader = document.createElement('th');
            newHeader.style.cssText = 'padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;';
            newHeader.textContent = `Week ${nextWeekNumber}`;
            headerRow.appendChild(newHeader);
            
            // Add cells to existing rows
            bodyRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.style.cssText = 'padding: 8px; border: 1px solid #e5e7eb;';
                newCell.innerHTML = `
                    <textarea placeholder="Week ${nextWeekNumber} content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px; font-size: 0.8rem;"></textarea>
                `;
                row.appendChild(newCell);
            });
            
            alert(`✅ Week ${nextWeekNumber} column added!`);
        }

        function generateSubjectPlan() {
            const subjectId = document.getElementById('subjectSelect').value;
            const grade = document.getElementById('globalGradeLevel').value;
            const yearStart = document.getElementById('globalSchoolYearStart').value;
            const calendar = document.getElementById('globalCalendarSystem').value;
            
            if (!subjectId || !grade) {
                alert('Please select a subject and grade level first.');
                return;
            }
            
            const subject = subjects.find(s => s.id == subjectId);
            if (!subject) return;
            
            // Update the monthly planning title to show selected subject
            const titleElement = document.getElementById('monthlyPlanningTitle');
            if (titleElement) {
                titleElement.textContent = `${subject.emoji} ${subject.name} Monthly Curriculum Planning`;
            }
            
            // Auto-populate planning sections with sample data
            document.getElementById('learningGoals').value = `By the end of this unit, students will be able to:\n• Master key ${subject.name} concepts for ${grade}\n• Apply problem-solving strategies\n• Demonstrate understanding through assessments\n• Connect learning to real-world applications`;
            
            document.getElementById('prerequisites').value = `Students should have:\n• Completed previous grade level ${subject.name}\n• Basic foundational skills\n• Ability to follow multi-step instructions\n• Access to required materials and resources`;
            
            document.getElementById('teachingNotes').value = `Teaching Tips:\n• Break complex concepts into smaller steps\n• Use visual aids and hands-on activities\n• Provide regular feedback and encouragement\n• Adapt pace based on student understanding\n• Include review sessions before assessments`;
            
            document.getElementById('mappingInsights').value = `Cross-curricular connections:\n• Link ${subject.name} concepts to other subjects\n• Incorporate real-world applications\n• Use interdisciplinary projects\n• Connect to student interests and experiences`;
            
            // Update the calendar table with the new system
            updateCalendarTable();
            
            alert(`✅ Generated ${calendar} curriculum plan for ${subject.emoji} ${subject.name} (${grade})!\n\nThe planning sections have been populated with educational framework guidelines. You can now customize the content for your specific needs.`);
        }

        function generatePeriodPlan() {
            const period = document.getElementById('quarterSelect').value;
            const year = document.getElementById('academicYear').value;
            const country = document.getElementById('countryRegion').value;
            const language = document.getElementById('interfaceLanguage').value;
            
            const curriculum = globalCurricula[country];
            if (!curriculum) return;
            
            // Clear and populate weekly planning table with subjects from selected country
            const tableBody = document.getElementById('weeklyPlanTable');
            tableBody.innerHTML = '';
            
            // Add subjects based on selected country's curriculum
            curriculum.subjects.slice(0, 6).forEach(subjectName => {
                addSubjectRow(subjectName, 'Curriculum Resource');
            });
            
            // Update academic year based on school year start
            updateAcademicYear();
            
            alert(`✅ Generated period plan for ${period} ${year}!\n\nCountry: ${curriculum.name}\nStandards: ${curriculum.standards}\nInterface: ${language}\n\nThe weekly planning table has been populated with subjects from the ${curriculum.name} curriculum. You can now add specific content for each week.`);
        }

        // Progress tracking
        function loadProgressCharts() {
            const container = document.getElementById('progressCharts');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const chartDiv = document.createElement('div');
                chartDiv.style.cssText = 'margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 12px;';
                chartDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #374151;">${subject.emoji} ${subject.name}</span>
                        <span style="font-weight: 600; color: #6366f1;">${subject.progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${subject.progress}%"></div>
                    </div>
                `;
                container.appendChild(chartDiv);
            });
        }

        function loadMilestones() {
            const container = document.getElementById('milestones');
            
            // Get milestones from localStorage or use defaults
            let milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            
            if (milestones.length === 0) {
                milestones = [
                    { id: 1, title: 'First Week Complete', description: 'Complete your first week of curriculum planning', achieved: false, target: 7, current: 0, type: 'days' },
                    { id: 2, title: 'Subject Master', description: 'Add 5 subjects to your curriculum', achieved: false, target: 5, current: subjects.length, type: 'subjects' },
                    { id: 3, title: 'Planning Pro', description: 'Complete monthly planning for one quarter', achieved: false, target: 1, current: 0, type: 'quarters' },
                    { id: 4, title: 'Schedule Setter', description: 'Create a full daily schedule template', achieved: false, target: 1, current: 0, type: 'schedules' }
                ];
            }
            
            // Update current progress for dynamic milestones
            milestones.forEach(milestone => {
                if (milestone.type === 'subjects') {
                    milestone.current = subjects.length;
                    milestone.achieved = milestone.current >= milestone.target;
                }
            });
            
            container.innerHTML = '';
            
            // Add milestone management header
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
            headerDiv.innerHTML = `
                <h4 style="margin: 0; color: #374151;">Your Learning Milestones</h4>
                <button class="btn" onclick="addCustomMilestone()" style="padding: 8px 16px; font-size: 0.9rem;">
                    ➕ Add Milestone
                </button>
            `;
            container.appendChild(headerDiv);
            
            milestones.forEach(milestone => {
                const progressPercent = Math.min(100, (milestone.current / milestone.target) * 100);
                const milestoneDiv = document.createElement('div');
                milestoneDiv.style.cssText = `
                    padding: 16px; 
                    background: ${milestone.achieved ? '#dcfce7' : '#f9fafb'}; 
                    border-radius: 12px; 
                    margin-bottom: 12px;
                    border-left: 4px solid ${milestone.achieved ? '#22c55e' : '#d1d5db'};
                `;
                milestoneDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <span style="font-size: 1.5rem;">${milestone.achieved ? '🏆' : '⏳'}</span>
                            <div style="flex: 1;">
                                <h4 style="margin-bottom: 4px; color: #374151;">${milestone.title}</h4>
                                <p style="color: #6b7280; margin: 0 0 8px 0;">${milestone.description}</p>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="flex: 1; background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${progressPercent}%; height: 100%; background: ${milestone.achieved ? '#22c55e' : '#3b82f6'}; transition: width 0.3s ease;"></div>
                                    </div>
                                    <span style="font-size: 0.8rem; color: #6b7280; font-weight: 600;">${milestone.current}/${milestone.target}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteMilestone(${milestone.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px; font-size: 1.2rem;" title="Delete milestone">🗑️</button>
                    </div>
                `;
                container.appendChild(milestoneDiv);
            });
            
            // Save updated milestones
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
        }

        function addCustomMilestone() {
            const title = prompt('Enter milestone title:');
            if (!title) return;
            
            const description = prompt('Enter milestone description:');
            if (!description) return;
            
            const target = parseInt(prompt('Enter target number:'));
            if (!target || target <= 0) return;
            
            const milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            const newMilestone = {
                id: Date.now(),
                title,
                description,
                achieved: false,
                target,
                current: 0,
                type: 'custom'
            };
            
            milestones.push(newMilestone);
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
            loadMilestones();
        }

        function deleteMilestone(id) {
            if (confirm('Are you sure you want to delete this milestone?')) {
                let milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
                milestones = milestones.filter(m => m.id !== id);
                localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
                loadMilestones();
            }
        }

        function updateMilestoneProgress(type, increment = 1) {
            let milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            milestones.forEach(milestone => {
                if (milestone.type === type && !milestone.achieved) {
                    milestone.current = Math.min(milestone.target, milestone.current + increment);
                    milestone.achieved = milestone.current >= milestone.target;
                }
            });
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
        }

        function updateOverviewStats() {
            document.getElementById('totalSubjects').textContent = subjects.length;
            document.getElementById('completedLessons').textContent = lessons.filter(l => l.status === 'completed').length;
            
            const avgProgress = subjects.reduce((sum, subject) => sum + subject.progress, 0) / subjects.length;
            document.getElementById('overallProgress').textContent = Math.round(avgProgress);
            
            const totalHours = lessons.reduce((sum, lesson) => sum + lesson.duration, 0) / 60;
            document.getElementById('weeklyHours').textContent = Math.round(totalHours);
        }

        // Export and save functions
        function exportToPDF() {
            alert('📄 PDF Export Feature\n\nThis would generate a comprehensive PDF report including:\n• Curriculum overview and progress\n• Subject planning details\n• Weekly schedules\n• Daily time slots\n• Assessment records\n\nNote: This is a demo - in a full implementation, this would use a PDF library like jsPDF or html2pdf.');
        }

        function printPlanner() {
            window.print();
        }

        function saveTemplate() {
            const templateData = {
                learnerName: document.getElementById('learnerName')?.value || '',
                teacherName: document.getElementById('teacherName')?.value || '',
                subjects: subjects,
                lessons: lessons,
                planningData: {
                    learningGoals: document.getElementById('learningGoals')?.value || '',
                    prerequisites: document.getElementById('prerequisites')?.value || '',
                    teachingNotes: document.getElementById('teachingNotes')?.value || '',
                    mappingInsights: document.getElementById('mappingInsights')?.value || ''
                },
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('eduflow_template', JSON.stringify(templateData));
            alert('💾 Template Saved Successfully!\n\nYour curriculum template has been saved locally. You can restore it anytime by refreshing the page.');
        }

        // Daily schedule functions
        function loadScheduleTemplate() {
            const template = document.getElementById('scheduleTemplate').value;
            const tableBody = document.getElementById('scheduleTable');
            tableBody.innerHTML = '';
            
            let timeSlots = [];
            
            switch(template) {
                case 'standard':
                    timeSlots = [
                        '8:00 AM - 8:30 AM', '8:30 AM - 9:30 AM', '9:30 AM - 10:30 AM', '10:30 AM - 10:45 AM',
                        '10:45 AM - 11:45 AM', '11:45 AM - 12:45 PM', '12:45 PM - 1:30 PM', '1:30 PM - 2:30 PM', '2:30 PM - 3:00 PM'
                    ];
                    break;
                case 'extended':
                    timeSlots = [
                        '7:00 AM - 7:30 AM', '7:30 AM - 8:30 AM', '8:30 AM - 9:30 AM', '9:30 AM - 10:30 AM', '10:30 AM - 10:45 AM',
                        '10:45 AM - 11:45 AM', '11:45 AM - 12:45 PM', '12:45 PM - 1:30 PM', '1:30 PM - 2:30 PM', 
                        '2:30 PM - 3:30 PM', '3:30 PM - 4:30 PM', '4:30 PM - 5:00 PM'
                    ];
                    break;
                case 'flexible':
                    timeSlots = [
                        'Morning Block 1', 'Morning Block 2', 'Mid-Morning Break', 'Late Morning Block', 
                        'Lunch Period', 'Afternoon Block 1', 'Afternoon Block 2', 'Evening Wrap-up'
                    ];
                    break;
                default:
                    timeSlots = ['Custom Time Slot 1', 'Custom Time Slot 2', 'Custom Time Slot 3'];
            }
            
            timeSlots.forEach(timeSlot => {
                addTimeSlot(timeSlot);
            });
        }

        function addTimeSlot(timeSlot = '') {
            const tableBody = document.getElementById('scheduleTable');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <input type="text" value="${timeSlot}" placeholder="Time slot" style="width: 100%; border: none; background: transparent; padding: 4px; font-weight: 600;" onchange="updateWeeklyFromDaily()">
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <select style="width: 100%; border: none; background: transparent; padding: 4px;" onchange="updateWeeklyFromDaily()">
                        <option value="">Select Subject</option>
                        <option value="mathematics">🔢 Mathematics</option>
                        <option value="science">🔬 Science</option>
                        <option value="english">📝 English</option>
                        <option value="history">🏛️ History</option>
                        <option value="art">🎨 Art</option>
                        <option value="music">🎵 Music</option>
                        <option value="break">☕ Break</option>
                        <option value="lunch">🍽️ Lunch</option>
                        <option value="pe">🏃 Physical Education</option>
                        <option value="other">📚 Other</option>
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <textarea placeholder="Learning objectives for this time slot..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <textarea placeholder="Activities and tasks..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <textarea placeholder="Materials needed..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    <textarea placeholder="Notes..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
                </td>
            `;
            
            tableBody.appendChild(row);
        }

        // Weekly schedule functions
        function showWeeklyView() {
            openModal('weeklyScheduleModal');
            generateWeeklySchedule();
        }

        function updateWeeklyFromDaily() {
            // This function syncs daily schedule changes to the weekly view
            console.log('Daily schedule updated - weekly view will reflect changes when opened');
            // In a full implementation, this would update the weekly schedule data structure
        }

        function generateWeeklySchedule() {
            const tableBody = document.getElementById('weeklyScheduleTable');
            tableBody.innerHTML = '';
            
            const timeSlots = [
                '8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM', 
                '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM'
            ];
            
            timeSlots.forEach(time => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600; background: #f8fafc;">${time}</td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                    <td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function exportWeeklySchedule() {
            alert('📄 Weekly Schedule Export\n\nThis would export your complete weekly schedule as a PDF or print-friendly format.\n\nNote: This is a demo feature.');
        }

        function updateDaySchedule() {
            const selectedDay = document.getElementById('scheduleDay').value;
            console.log(`Switched to ${selectedDay} schedule`);
            // In a full implementation, this would load day-specific schedule data
        }

        // Update header info with participant information
        function updateHeaderInfo() {
            const learnerName = document.getElementById('learnerName')?.value || '';
            const teacherName = document.getElementById('teacherName')?.value || '';
            const gradeLevel = document.getElementById('globalGradeLevel')?.value || '';
            const academicYear = document.getElementById('globalAcademicYear')?.value || '';
            
            const headerInfo = document.getElementById('headerInfo');
            const inputSection = document.getElementById('inputSection');
            const headerLearner = document.getElementById('headerLearner');
            const headerTeacher = document.getElementById('headerTeacher');
            const headerGrade = document.getElementById('headerGrade');
            const headerYear = document.getElementById('headerYear');
            
            // Show info display and hide input section if any field has content
            if (learnerName || teacherName || gradeLevel || academicYear) {
                headerInfo.style.display = 'flex';
                inputSection.style.display = 'none';
                headerLearner.innerHTML = `👨‍🎓 Learner: <strong>${learnerName || 'Not Set'}</strong>`;
                headerTeacher.innerHTML = `👩‍🏫 Teacher: <strong>${teacherName || 'Not Set'}</strong>`;
                headerGrade.innerHTML = `🎓 Grade: <strong>${gradeLevel || 'Not Set'}</strong>`;
                headerYear.innerHTML = `📅 Year: <strong>${academicYear || 'Not Set'}</strong>`;
                
                // Add edit button to allow changes
                if (!document.getElementById('editHeaderBtn')) {
                    const editBtn = document.createElement('button');
                    editBtn.id = 'editHeaderBtn';
                    editBtn.innerHTML = '✏️ Edit';
                    editBtn.className = 'btn';
                    editBtn.style.cssText = 'padding: 6px 12px; font-size: 0.8rem; margin-left: 16px;';
                    editBtn.onclick = function() {
                        headerInfo.style.display = 'none';
                        inputSection.style.display = 'grid';
                        editBtn.remove();
                    };
                    headerInfo.appendChild(editBtn);
                }
            } else {
                headerInfo.style.display = 'none';
                inputSection.style.display = 'grid';
                const editBtn = document.getElementById('editHeaderBtn');
                if (editBtn) editBtn.remove();
            }
        }

        // Legacy function for compatibility
        function updateHeaderSubtitle() {
            updateHeaderInfo();
        }

        // Add event listeners for header updates
        function addHeaderUpdateListeners() {
            const fieldsToWatch = ['learnerName', 'teacherName', 'globalGradeLevel', 'globalAcademicYear', 'globalSchoolYearStart'];
            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        updateHeaderInfo();
                        triggerAutoSave();
                    });
                    field.addEventListener('change', function() {
                        updateHeaderInfo();
                        triggerAutoSave();
                    });
                    if (fieldId === 'globalSchoolYearStart') {
                        field.addEventListener('change', updateAcademicYearFromStart);
                    }
                }
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date for lesson form to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lessonDate').value = today;
            document.getElementById('scheduleDate').value = today;
            
            // Set default school year start to current September in global settings
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const schoolYear = currentMonth >= 8 ? currentYear : currentYear - 1; // September = month 8
            document.getElementById('globalSchoolYearStart').value = `${schoolYear}-09`;
            
            // Initialize global settings
            updateGlobalCountrySettings();
            updateGlobalCalendarSystem();
            
            // Try to load auto-saved data first, then fall back to template
            const autoSaveLoaded = loadAutoSavedData();
            
            if (!autoSaveLoaded) {
                // Load saved template if exists and no auto-save data
                const savedTemplate = localStorage.getItem('eduflow_template');
                if (savedTemplate) {
                    try {
                        const data = JSON.parse(savedTemplate);
                        if (data.learnerName) document.getElementById('learnerName').value = data.learnerName;
                        if (data.teacherName) document.getElementById('teacherName').value = data.teacherName;
                        if (data.planningData) {
                            if (data.planningData.learningGoals) document.getElementById('learningGoals').value = data.planningData.learningGoals;
                            if (data.planningData.prerequisites) document.getElementById('prerequisites').value = data.planningData.prerequisites;
                            if (data.planningData.teachingNotes) document.getElementById('teachingNotes').value = data.planningData.teachingNotes;
                            if (data.planningData.mappingInsights) document.getElementById('mappingInsights').value = data.planningData.mappingInsights;
                        }
                    } catch (e) {
                        console.log('Could not load saved template');
                    }
                }
            }
            
            // Initialize all interconnected data
            updateAllSections();
            addHeaderUpdateListeners();
            
            // Setup auto-save functionality
            setupAutoSaveListeners();
            createSaveIndicator();
            
            // Update header info after data is loaded
            setTimeout(() => {
                updateHeaderInfo();
                updateSubjectTitle();
            }, 100);
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96eba5ce60f1ee78',t:'MTc1NTEyNDEyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
